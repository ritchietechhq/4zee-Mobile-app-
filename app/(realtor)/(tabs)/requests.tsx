// ============================================================
// Realtor Requests Screen
// Shows Property Applications + Installment Plan Requests
// with segment control to switch between views
// ============================================================

import React, { useEffect, useState, useCallback, useMemo } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  RefreshControl,
  TouchableOpacity,
  Alert,
  Modal,
  TextInput,
  ActivityIndicator,
  Linking,
} from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import { Image } from 'expo-image';
import { Ionicons } from '@expo/vector-icons';
import { useRealtorColors } from '@/hooks/useThemeColors';
import { realtorService } from '@/services/realtor.service';
import { Badge } from '@/components/ui/Badge';
import { Button } from '@/components/ui/Button';
import { Skeleton } from '@/components/ui/Skeleton';
import { EmptyState } from '@/components/ui/EmptyState';
import { Spacing, Typography, BorderRadius, Shadows, Colors } from '@/constants/theme';
import { FLATLIST_PERF_PROPS } from '@/utils/performance';
import { formatCurrency } from '@/utils/formatCurrency';
import type { ThemeColors } from '@/constants/colors';
import type { Application, InstallmentRequest, InstallmentRequestStatus } from '@/types';

type Segment = 'applications' | 'installments';
type AppFilterStatus = 'ALL' | 'PENDING' | 'APPROVED' | 'REJECTED';
type InstFilterStatus = 'ALL' | InstallmentRequestStatus;

export default function RequestsScreen() {
  const insets = useSafeAreaInsets();
  const colors = useRealtorColors();
  const styles = useMemo(() => makeStyles(colors), [colors]);

  // ?????? Segment state ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const [segment, setSegment] = useState<Segment>('applications');

  // ?????? Applications state ????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const [applications, setApplications] = useState<Application[]>([]);
  const [appsLoading, setAppsLoading] = useState(true);
  const [appsRefreshing, setAppsRefreshing] = useState(false);
  const [appsError, setAppsError] = useState<string | null>(null);
  const [appFilter, setAppFilter] = useState<AppFilterStatus>('ALL');
  const [appsProcessing, setAppsProcessing] = useState(false);

  // ?????? Installment state ???????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const [instRequests, setInstRequests] = useState<InstallmentRequest[]>([]);
  const [instLoading, setInstLoading] = useState(true);
  const [instRefreshing, setInstRefreshing] = useState(false);
  const [instError, setInstError] = useState<string | null>(null);
  const [instFilter, setInstFilter] = useState<InstFilterStatus>('ALL');
  const [instProcessing, setInstProcessing] = useState(false);

  // ?????? Rejection modal ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const [rejectModalVisible, setRejectModalVisible] = useState(false);
  const [rejectTarget, setRejectTarget] = useState<{ type: 'app' | 'inst'; item: any } | null>(null);
  const [rejectionReason, setRejectionReason] = useState('');

  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  // Applications fetching
  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const fetchApplications = useCallback(async () => {
    try {
      setAppsError(null);
      const statusFilter = appFilter === 'ALL' ? undefined : appFilter;
      const response = await realtorService.getApplications(statusFilter);
      if (__DEV__) console.log('[Requests/Apps] received items:', response.items?.length, 'total:', response.total);
      setApplications(response.items ?? []);
    } catch (error: any) {
      const msg = error?.error?.message || error?.message || 'Failed to load applications';
      if (__DEV__) console.error('[Requests/Apps] fetch error:', msg);
      setAppsError(msg);
      setApplications([]);
    } finally {
      setAppsLoading(false);
    }
  }, [appFilter]);

  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  // Installment requests fetching
  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const fetchInstRequests = useCallback(async () => {
    try {
      setInstError(null);
      const statusFilter = instFilter === 'ALL' ? undefined : instFilter;
      const response = await realtorService.getInstallmentRequests(statusFilter);
      if (__DEV__) console.log('[Requests/Inst] received items:', response.items?.length, 'total:', response.total);
      setInstRequests(response.items ?? []);
    } catch (error: any) {
      const msg = error?.error?.message || error?.message || 'Failed to load installment requests';
      if (__DEV__) console.error('[Requests/Inst] fetch error:', msg);
      setInstError(msg);
      setInstRequests([]);
    } finally {
      setInstLoading(false);
    }
  }, [instFilter]);

  // Load both on mount
  useEffect(() => { fetchApplications(); }, [fetchApplications]);
  useEffect(() => { fetchInstRequests(); }, [fetchInstRequests]);

  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  // Refresh handlers
  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const onRefreshApps = useCallback(async () => {
    setAppsRefreshing(true);
    await fetchApplications();
    setAppsRefreshing(false);
  }, [fetchApplications]);

  const onRefreshInst = useCallback(async () => {
    setInstRefreshing(true);
    await fetchInstRequests();
    setInstRefreshing(false);
  }, [fetchInstRequests]);

  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  // Application actions
  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const handleApproveApp = useCallback(async (app: Application) => {
    Alert.alert(
      'Approve Application',
      `Approve ${app.client?.user?.firstName ?? 'Client'} ${app.client?.user?.lastName ?? ''}'s application for "${app.property?.title}"?`,
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Approve',
          onPress: async () => {
            setAppsProcessing(true);
            try {
              const updated = await realtorService.approveApplication(app.id);
              setApplications(prev => prev.map(a => a.id === app.id ? updated : a));
              Alert.alert('Success', 'Application approved successfully!');
            } catch (error: any) {
              Alert.alert('Error', error?.message || 'Failed to approve application.');
            } finally {
              setAppsProcessing(false);
            }
          },
        },
      ],
    );
  }, []);

  const openAppRejectModal = useCallback((app: Application) => {
    setRejectTarget({ type: 'app', item: app });
    setRejectionReason('');
    setRejectModalVisible(true);
  }, []);

  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  // Installment actions
  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const handleApproveInst = useCallback(async (request: InstallmentRequest) => {
    Alert.alert(
      'Approve Request',
      `Approve installment plan request from ${request.client.firstName} ${request.client.lastName}?\n\nThis will generate a payment agreement.`,
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Approve',
          onPress: async () => {
            setInstProcessing(true);
            try {
              const updated = await realtorService.approveInstallmentRequest(request.id);
              setInstRequests(prev => prev.map(r => r.id === request.id ? updated : r));
              Alert.alert('Success', 'Installment request approved!');
            } catch (error: any) {
              Alert.alert('Error', error?.message || 'Failed to approve request.');
            } finally {
              setInstProcessing(false);
            }
          },
        },
      ],
    );
  }, []);

  const openInstRejectModal = useCallback((request: InstallmentRequest) => {
    setRejectTarget({ type: 'inst', item: request });
    setRejectionReason('');
    setRejectModalVisible(true);
  }, []);

  const handleViewAgreement = useCallback(async (request: InstallmentRequest) => {
    if (request.agreement?.documentUrl) {
      await Linking.openURL(request.agreement.documentUrl);
    } else {
      Alert.alert('Agreement', 'Agreement document is being generated. Please check back later.');
    }
  }, []);

  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  // Shared reject handler
  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const handleReject = useCallback(async () => {
    if (!rejectTarget || !rejectionReason.trim()) {
      Alert.alert('Error', 'Please provide a reason for rejection.');
      return;
    }
    const isApp = rejectTarget.type === 'app';
    const setProcessing = isApp ? setAppsProcessing : setInstProcessing;
    setProcessing(true);
    try {
      if (isApp) {
        const updated = await realtorService.rejectApplication(rejectTarget.item.id, rejectionReason.trim());
        setApplications(prev => prev.map(a => a.id === rejectTarget.item.id ? updated : a));
      } else {
        const updated = await realtorService.rejectInstallmentRequest(rejectTarget.item.id, rejectionReason.trim());
        setInstRequests(prev => prev.map(r => r.id === rejectTarget.item.id ? updated : r));
      }
      setRejectModalVisible(false);
      setRejectTarget(null);
      Alert.alert('Success', `${isApp ? 'Application' : 'Request'} has been rejected.`);
    } catch (error: any) {
      Alert.alert('Error', error?.message || 'Failed to reject. Please try again.');
    } finally {
      setProcessing(false);
    }
  }, [rejectTarget, rejectionReason]);

  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  // Filtered data
  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const filteredApps = useMemo(() => {
    if (!applications) return [];
    if (appFilter === 'ALL') return applications;
    return applications.filter(a => a.status === appFilter);
  }, [applications, appFilter]);

  const filteredInst = useMemo(() => {
    if (!instRequests) return [];
    if (instFilter === 'ALL') return instRequests;
    return instRequests.filter(r => r.status === instFilter);
  }, [instRequests, instFilter]);

  const pendingApps = useMemo(() => (applications ?? []).filter(a => a.status === 'PENDING').length, [applications]);
  const pendingInst = useMemo(() => (instRequests ?? []).filter(r => r.status === 'PENDING').length, [instRequests]);

  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  // Render helpers
  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const renderSegment = () => (
    <View style={styles.segmentWrap}>
      <TouchableOpacity
        style={[styles.segmentBtn, segment === 'applications' && styles.segmentBtnActive]}
        onPress={() => setSegment('applications')}
        activeOpacity={0.7}
      >
        <Ionicons
          name={segment === 'applications' ? 'document-text' : 'document-text-outline'}
          size={16}
          color={segment === 'applications' ? colors.white : colors.textSecondary}
        />
        <Text style={[styles.segmentText, segment === 'applications' && styles.segmentTextActive]}>
          Applications
        </Text>
        {pendingApps > 0 && (
          <View style={[styles.segmentBadge, segment === 'applications' && styles.segmentBadgeActive]}>
            <Text style={styles.segmentBadgeText}>{pendingApps}</Text>
          </View>
        )}
      </TouchableOpacity>
      <TouchableOpacity
        style={[styles.segmentBtn, segment === 'installments' && styles.segmentBtnActive]}
        onPress={() => setSegment('installments')}
        activeOpacity={0.7}
      >
        <Ionicons
          name={segment === 'installments' ? 'card' : 'card-outline'}
          size={16}
          color={segment === 'installments' ? colors.white : colors.textSecondary}
        />
        <Text style={[styles.segmentText, segment === 'installments' && styles.segmentTextActive]}>
          Installments
        </Text>
        {pendingInst > 0 && (
          <View style={[styles.segmentBadge, segment === 'installments' && styles.segmentBadgeActive]}>
            <Text style={styles.segmentBadgeText}>{pendingInst}</Text>
          </View>
        )}
      </TouchableOpacity>
    </View>
  );

  const renderFilterPill = (status: string, label: string, isActive: boolean, onPress: () => void) => (
    <TouchableOpacity
      key={status}
      style={[styles.filterPill, isActive && styles.filterPillActive]}
      onPress={onPress}
      activeOpacity={0.7}
    >
      <Text style={[styles.filterPillText, isActive && styles.filterPillTextActive]}>
        {label}
      </Text>
    </TouchableOpacity>
  );

  // ?????? Application card ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const renderApplication = useCallback(({ item }: { item: Application }) => {
    const statusVariant =
      item.status === 'APPROVED' ? 'success' :
      item.status === 'REJECTED' ? 'error' : 'warning';

    const clientName = item.client?.user
      ? `${item.client.user.firstName} ${item.client.user.lastName}`.trim()
      : 'Client';
    const clientEmail = item.client?.user?.email;
    const clientInitial = clientName.charAt(0).toUpperCase();
    const propertyImage = item.property?.images?.[0];
    const createdDate = new Date(item.createdAt).toLocaleDateString('en-NG', {
      day: 'numeric', month: 'short', year: 'numeric',
    });

    return (
      <View style={styles.requestCard}>
        {/* Property Preview */}
        <View style={styles.propertyRow}>
          {propertyImage ? (
            <Image
              source={{ uri: propertyImage }}
              style={styles.propertyImage}
              contentFit="cover"
              placeholder="L6PZfSi_.AyE_3t7t7R**0o#DgR4"
              transition={200}
              cachePolicy="memory-disk"
            />
          ) : (
            <View style={[styles.propertyImage, styles.propertyImagePlaceholder]}>
              <Ionicons name="home-outline" size={28} color={colors.textMuted} />
            </View>
          )}
          <View style={styles.propertyInfo}>
            <Text style={styles.propertyTitle} numberOfLines={1}>{item.property?.title ?? 'Property'}</Text>
            <Text style={styles.propertyPrice}>{formatCurrency(item.property?.price ?? 0)}</Text>
            <Badge label={item.status} variant={statusVariant} size="sm" />
          </View>
        </View>

        {/* Client Info */}
        <View style={styles.clientRow}>
          <View style={[styles.clientAvatar, { backgroundColor: colors.primaryLight }]}>
            <Text style={[styles.clientAvatarText, { color: colors.primary }]}>{clientInitial}</Text>
          </View>
          <View style={styles.clientInfo}>
            <Text style={styles.clientName}>{clientName}</Text>
            {clientEmail && <Text style={styles.clientEmail}>{clientEmail}</Text>}
          </View>
        </View>

        {/* Payment Status */}
        {item.paymentStatus && (
          <View style={styles.paymentStatusRow}>
            <Ionicons
              name={item.paymentStatus === 'PAID' ? 'checkmark-circle' : 'time-outline'}
              size={16}
              color={item.paymentStatus === 'PAID' ? Colors.success : Colors.warning}
            />
            <Text style={[
              styles.paymentStatusText,
              { color: item.paymentStatus === 'PAID' ? Colors.success : Colors.warning },
            ]}>
              Payment: {item.paymentStatus}
            </Text>
          </View>
        )}

        {/* Date */}
        <Text style={styles.requestedAt}>Applied: {createdDate}</Text>

        {/* Actions */}
        {item.status === 'PENDING' && (
          <View style={styles.actions}>
            <Button
              title="Reject"
              variant="outline"
              size="sm"
              style={styles.actionBtn}
              onPress={() => openAppRejectModal(item)}
              disabled={appsProcessing}
            />
            <Button
              title="Approve"
              variant="primary"
              size="sm"
              style={[styles.actionBtn, styles.approveBtn]}
              onPress={() => handleApproveApp(item)}
              disabled={appsProcessing}
              icon={<Ionicons name="checkmark" size={16} color={Colors.white} />}
            />
          </View>
        )}
      </View>
    );
  }, [styles, colors, appsProcessing, handleApproveApp, openAppRejectModal]);

  // ?????? Installment request card ?????????????????????????????????????????????????????????????????????????????????????????????
  const renderInstRequest = useCallback(({ item }: { item: InstallmentRequest }) => {
    const statusVariant =
      item.status === 'APPROVED' ? 'success' :
      item.status === 'REJECTED' ? 'error' : 'warning';

    return (
      <View style={styles.requestCard}>
        {/* Property Preview */}
        <View style={styles.propertyRow}>
          <Image
            source={{ uri: item.property.images?.[0] }}
            style={styles.propertyImage}
            contentFit="cover"
            placeholder="L6PZfSi_.AyE_3t7t7R**0o#DgR4"
            transition={200}
            cachePolicy="memory-disk"
          />
          <View style={styles.propertyInfo}>
            <Text style={styles.propertyTitle} numberOfLines={1}>{item.property.title}</Text>
            <Text style={styles.propertyPrice}>{formatCurrency(item.property.price)}</Text>
            <Badge label={item.status} variant={statusVariant} size="sm" />
          </View>
        </View>

        {/* Client Info */}
        <View style={styles.clientRow}>
          <View style={[styles.clientAvatar, { backgroundColor: colors.primaryLight }]}>
            <Ionicons name="person" size={20} color={colors.primary} />
          </View>
          <View style={styles.clientInfo}>
            <Text style={styles.clientName}>{item.client.firstName} {item.client.lastName}</Text>
            {item.client.email && <Text style={styles.clientEmail}>{item.client.email}</Text>}
          </View>
        </View>

        {/* Plan Details */}
        <View style={styles.planDetails}>
          <Text style={styles.planName}>{item.paymentPlan.name}</Text>
          <View style={styles.planStats}>
            <View style={styles.planStat}>
              <Text style={styles.planStatLabel}>Down Payment</Text>
              <Text style={styles.planStatValue}>{formatCurrency(item.downPayment)}</Text>
            </View>
            <View style={styles.planStat}>
              <Text style={styles.planStatLabel}>Monthly</Text>
              <Text style={styles.planStatValue}>{formatCurrency(item.monthlyAmount)}</Text>
            </View>
            <View style={styles.planStat}>
              <Text style={styles.planStatLabel}>Duration</Text>
              <Text style={styles.planStatValue}>{item.paymentPlan.durationMonths} months</Text>
            </View>
          </View>
          <View style={styles.totalRow}>
            <Text style={styles.totalLabel}>Total Amount</Text>
            <Text style={styles.totalValue}>{formatCurrency(item.totalAmount)}</Text>
          </View>
        </View>

        {/* Requested Date */}
        <Text style={styles.requestedAt}>
          Requested: {new Date(item.requestedAt).toLocaleDateString('en-NG', {
            day: 'numeric', month: 'short', year: 'numeric',
          })}
        </Text>

        {/* Actions */}
        {item.status === 'PENDING' && (
          <View style={styles.actions}>
            <Button
              title="Reject"
              variant="outline"
              size="sm"
              style={styles.actionBtn}
              onPress={() => openInstRejectModal(item)}
              disabled={instProcessing}
            />
            <Button
              title="Approve"
              variant="primary"
              size="sm"
              style={[styles.actionBtn, styles.approveBtn]}
              onPress={() => handleApproveInst(item)}
              disabled={instProcessing}
              icon={<Ionicons name="checkmark" size={16} color={Colors.white} />}
            />
          </View>
        )}

        {item.status === 'APPROVED' && item.agreement && (
          <View style={styles.actions}>
            <Button
              title="View Agreement"
              variant="primary"
              size="sm"
              style={styles.actionBtn}
              onPress={() => handleViewAgreement(item)}
              icon={<Ionicons name="document-text-outline" size={16} color={Colors.white} />}
            />
          </View>
        )}

        {item.status === 'REJECTED' && item.rejectionReason && (
          <View style={styles.rejectionBox}>
            <Ionicons name="close-circle" size={16} color={colors.error} />
            <Text style={styles.rejectionText}>{item.rejectionReason}</Text>
          </View>
        )}
      </View>
    );
  }, [styles, colors, instProcessing, handleApproveInst, openInstRejectModal, handleViewAgreement]);

  // ?????? Skeleton ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const renderSkeleton = () => (
    <View style={styles.skeletonWrap}>
      {[1, 2, 3].map(i => (
        <View key={i} style={styles.skeletonCard}>
          <View style={styles.propertyRow}>
            <Skeleton width={80} height={80} borderRadius={BorderRadius.lg} />
            <View style={{ flex: 1, marginLeft: Spacing.md }}>
              <Skeleton width="70%" height={16} style={{ marginBottom: 8 }} />
              <Skeleton width="50%" height={14} style={{ marginBottom: 8 }} />
              <Skeleton width={60} height={22} borderRadius={BorderRadius.sm} />
            </View>
          </View>
        </View>
      ))}
    </View>
  );

  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  // Main render
  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const isLoading = segment === 'applications' ? appsLoading : instLoading;
  const isRefreshing = segment === 'applications' ? appsRefreshing : instRefreshing;
  const onRefresh = segment === 'applications' ? onRefreshApps : onRefreshInst;
  const isProcessing = segment === 'applications' ? appsProcessing : instProcessing;
  const fetchError = segment === 'applications' ? appsError : instError;

  return (
    <View style={[styles.container, { paddingTop: insets.top }]}>
      {/* Header */}
      <View style={styles.header}>
        <Text style={styles.title}>Requests</Text>
        <Text style={styles.subtitle}>
          {pendingApps + pendingInst > 0
            ? `${pendingApps + pendingInst} pending request${pendingApps + pendingInst > 1 ? 's' : ''}`
            : 'No pending requests'}
        </Text>
      </View>

      {/* Segment Control */}
      {renderSegment()}

      {/* Filters */}
      {segment === 'applications' ? (
        <View style={styles.filters}>
          {renderFilterPill('ALL', 'All', appFilter === 'ALL', () => setAppFilter('ALL'))}
          {renderFilterPill('PENDING', `Pending${pendingApps > 0 ? ` (${pendingApps})` : ''}`, appFilter === 'PENDING', () => setAppFilter('PENDING'))}
          {renderFilterPill('APPROVED', 'Approved', appFilter === 'APPROVED', () => setAppFilter('APPROVED'))}
          {renderFilterPill('REJECTED', 'Rejected', appFilter === 'REJECTED', () => setAppFilter('REJECTED'))}
        </View>
      ) : (
        <View style={styles.filters}>
          {renderFilterPill('ALL', 'All', instFilter === 'ALL', () => setInstFilter('ALL'))}
          {renderFilterPill('PENDING', `Pending${pendingInst > 0 ? ` (${pendingInst})` : ''}`, instFilter === 'PENDING', () => setInstFilter('PENDING'))}
          {renderFilterPill('APPROVED', 'Approved', instFilter === 'APPROVED', () => setInstFilter('APPROVED'))}
          {renderFilterPill('REJECTED', 'Rejected', instFilter === 'REJECTED', () => setInstFilter('REJECTED'))}
        </View>
      )}

      {/* Content */}
      {isLoading ? renderSkeleton() : segment === 'applications' ? (
        <FlatList
          data={filteredApps}
          keyExtractor={(item) => item.id}
          renderItem={renderApplication}
          contentContainerStyle={styles.listContent}
          showsVerticalScrollIndicator={false}
          refreshControl={
            <RefreshControl refreshing={isRefreshing} onRefresh={onRefresh} tintColor={colors.primary} />
          }
          ListEmptyComponent={
            <EmptyState
              icon={fetchError ? 'alert-circle-outline' : 'document-text-outline'}
              title={fetchError ? 'Failed to load applications' : 'No applications'}
              description={
                fetchError
                  ? `Error: ${fetchError}\n\nPull down to retry.`
                  : appFilter === 'ALL'
                    ? "You don't have any property applications yet. They'll appear here when clients apply for your properties."
                    : `No ${appFilter.toLowerCase()} applications found.`
              }
            />
          }
          ListFooterComponent={<View style={{ height: Spacing.xxxxl }} />}
          {...FLATLIST_PERF_PROPS}
        />
      ) : (
        <FlatList
          data={filteredInst}
          keyExtractor={(item) => item.id}
          renderItem={renderInstRequest}
          contentContainerStyle={styles.listContent}
          showsVerticalScrollIndicator={false}
          refreshControl={
            <RefreshControl refreshing={isRefreshing} onRefresh={onRefresh} tintColor={colors.primary} />
          }
          ListEmptyComponent={
            <EmptyState
              icon={fetchError ? 'alert-circle-outline' : 'card-outline'}
              title={fetchError ? 'Failed to load requests' : 'No installment requests'}
              description={
                fetchError
                  ? `Error: ${fetchError}\n\nPull down to retry.`
                  : instFilter === 'ALL'
                    ? "No installment plan requests yet. They'll appear when clients request payment plans for your properties."
                    : `No ${instFilter.toLowerCase()} requests found.`
              }
            />
          }
          ListFooterComponent={<View style={{ height: Spacing.xxxxl }} />}
          {...FLATLIST_PERF_PROPS}
        />
      )}

      {/* Rejection Modal */}
      <Modal visible={rejectModalVisible} transparent animationType="fade">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>
                Reject {rejectTarget?.type === 'app' ? 'Application' : 'Request'}
              </Text>
              <TouchableOpacity onPress={() => setRejectModalVisible(false)} disabled={isProcessing}>
                <Ionicons name="close" size={24} color={colors.textSecondary} />
              </TouchableOpacity>
            </View>
            <Text style={styles.modalDescription}>
              Please provide a reason for rejecting this {rejectTarget?.type === 'app' ? 'application' : 'installment plan request'}.
            </Text>
            <TextInput
              style={styles.reasonInput}
              placeholder="Enter rejection reason..."
              placeholderTextColor={colors.textMuted}
              value={rejectionReason}
              onChangeText={setRejectionReason}
              multiline
              numberOfLines={4}
              textAlignVertical="top"
              editable={!isProcessing}
            />
            <View style={styles.modalActions}>
              <Button
                title="Cancel"
                variant="outline"
                size="md"
                style={{ flex: 1, marginRight: Spacing.sm }}
                onPress={() => setRejectModalVisible(false)}
                disabled={isProcessing}
              />
              <Button
                title={isProcessing ? 'Rejecting...' : 'Reject'}
                variant="danger"
                size="md"
                style={{ flex: 1 }}
                onPress={handleReject}
                disabled={isProcessing || !rejectionReason.trim()}
              />
            </View>
          </View>
        </View>
      </Modal>

      {/* Processing Overlay */}
      {isProcessing && (
        <View style={styles.processingOverlay}>
          <ActivityIndicator size="large" color={colors.primary} />
        </View>
      )}
    </View>
  );
}

const makeStyles = (colors: ThemeColors) => StyleSheet.create({
  container: { flex: 1, backgroundColor: colors.background },
  header: { paddingHorizontal: Spacing.xl, paddingTop: Spacing.lg, paddingBottom: Spacing.sm },
  title: { ...Typography.h3, color: colors.textPrimary },
  subtitle: { ...Typography.caption, color: colors.textSecondary, marginTop: 2 },

  // Segment control
  segmentWrap: {
    flexDirection: 'row',
    marginHorizontal: Spacing.xl,
    marginVertical: Spacing.sm,
    backgroundColor: colors.surface,
    borderRadius: BorderRadius.lg,
    padding: 3,
    borderWidth: 1,
    borderColor: colors.borderLight,
  },
  segmentBtn: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: Spacing.sm + 2,
    borderRadius: BorderRadius.md,
    gap: 6,
  },
  segmentBtnActive: {
    backgroundColor: colors.primary,
    ...Shadows.sm,
  },
  segmentText: { ...Typography.captionMedium, color: colors.textSecondary },
  segmentTextActive: { color: colors.white },
  segmentBadge: {
    minWidth: 18, height: 18, borderRadius: 9,
    backgroundColor: colors.error,
    alignItems: 'center', justifyContent: 'center',
    paddingHorizontal: 4,
  },
  segmentBadgeActive: { backgroundColor: 'rgba(255,255,255,0.3)' },
  segmentBadgeText: { ...Typography.small, color: colors.white, fontWeight: '700', fontSize: 10 },

  // Filters
  filters: { flexDirection: 'row', paddingHorizontal: Spacing.xl, paddingVertical: Spacing.sm, gap: Spacing.sm },
  filterPill: { paddingHorizontal: Spacing.md, paddingVertical: Spacing.xs, borderRadius: BorderRadius.full, backgroundColor: colors.surface, borderWidth: 1, borderColor: colors.border },
  filterPillActive: { backgroundColor: colors.primary, borderColor: colors.primary },
  filterPillText: { ...Typography.caption, color: colors.textSecondary, fontWeight: '600' },
  filterPillTextActive: { color: Colors.white },

  listContent: { paddingHorizontal: Spacing.xl, paddingTop: Spacing.md },

  // Request card (shared between apps & installments)
  requestCard: { backgroundColor: colors.cardBackground, borderRadius: BorderRadius.xl, padding: Spacing.lg, marginBottom: Spacing.md, borderWidth: 1, borderColor: colors.borderLight, ...Shadows.sm },

  propertyRow: { flexDirection: 'row', marginBottom: Spacing.md },
  propertyImage: { width: 80, height: 80, borderRadius: BorderRadius.lg },
  propertyImagePlaceholder: { backgroundColor: colors.surface, borderWidth: 1, borderColor: colors.borderLight, alignItems: 'center', justifyContent: 'center' },
  propertyInfo: { flex: 1, marginLeft: Spacing.md, justifyContent: 'center' },
  propertyTitle: { ...Typography.bodyMedium, color: colors.textPrimary, marginBottom: 4 },
  propertyPrice: { ...Typography.bodySemiBold, color: colors.primary, marginBottom: 6 },

  clientRow: { flexDirection: 'row', alignItems: 'center', paddingVertical: Spacing.sm, borderTopWidth: 1, borderTopColor: colors.borderLight, marginBottom: Spacing.sm },
  clientAvatar: { width: 36, height: 36, borderRadius: 18, alignItems: 'center', justifyContent: 'center' },
  clientAvatarText: { ...Typography.captionMedium, fontWeight: '700', fontSize: 14 },
  clientInfo: { flex: 1, marginLeft: Spacing.sm },
  clientName: { ...Typography.bodyMedium, color: colors.textPrimary },
  clientEmail: { ...Typography.caption, color: colors.textMuted },

  paymentStatusRow: { flexDirection: 'row', alignItems: 'center', gap: 6, marginBottom: Spacing.sm, paddingVertical: Spacing.xs, paddingHorizontal: Spacing.sm, backgroundColor: colors.surface, borderRadius: BorderRadius.md },
  paymentStatusText: { ...Typography.captionMedium },

  planDetails: { backgroundColor: colors.surface, borderRadius: BorderRadius.lg, padding: Spacing.md, marginBottom: Spacing.sm },
  planName: { ...Typography.bodySemiBold, color: colors.textPrimary, marginBottom: Spacing.sm },
  planStats: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: Spacing.sm },
  planStat: { alignItems: 'center' },
  planStatLabel: { ...Typography.caption, color: colors.textMuted, marginBottom: 2 },
  planStatValue: { ...Typography.bodyMedium, color: colors.textPrimary },
  totalRow: { flexDirection: 'row', justifyContent: 'space-between', paddingTop: Spacing.sm, borderTopWidth: 1, borderTopColor: colors.borderLight },
  totalLabel: { ...Typography.bodyMedium, color: colors.textSecondary },
  totalValue: { ...Typography.h4, color: colors.primary },

  requestedAt: { ...Typography.caption, color: colors.textMuted, marginBottom: Spacing.md },

  actions: { flexDirection: 'row', gap: Spacing.sm },
  actionBtn: { flex: 1 },
  approveBtn: { backgroundColor: Colors.success },

  rejectionBox: { flexDirection: 'row', alignItems: 'flex-start', backgroundColor: colors.errorLight, borderRadius: BorderRadius.md, padding: Spacing.sm, gap: Spacing.xs },
  rejectionText: { ...Typography.caption, color: colors.error, flex: 1 },

  skeletonWrap: { paddingHorizontal: Spacing.xl, paddingTop: Spacing.md, gap: Spacing.md },
  skeletonCard: { backgroundColor: colors.cardBackground, borderRadius: BorderRadius.xl, padding: Spacing.lg, borderWidth: 1, borderColor: colors.borderLight },

  modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center', alignItems: 'center', padding: Spacing.xl },
  modalContent: { backgroundColor: colors.cardBackground, borderRadius: BorderRadius.xl, padding: Spacing.xl, width: '100%', maxWidth: 400 },
  modalHeader: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: Spacing.md },
  modalTitle: { ...Typography.h4, color: colors.textPrimary },
  modalDescription: { ...Typography.body, color: colors.textSecondary, marginBottom: Spacing.md },
  reasonInput: { ...Typography.body, color: colors.textPrimary, backgroundColor: colors.surface, borderRadius: BorderRadius.lg, borderWidth: 1, borderColor: colors.border, padding: Spacing.md, minHeight: 100, marginBottom: Spacing.lg },
  modalActions: { flexDirection: 'row' },

  processingOverlay: { ...StyleSheet.absoluteFillObject, backgroundColor: 'rgba(0,0,0,0.3)', justifyContent: 'center', alignItems: 'center' },
});
